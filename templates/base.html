{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eligo Database</title>
    <link rel="stylesheet" href="{% static 'db/css/main.css' %}">
</head>
<body>
    {% include 'navbar.html'%}
    {% include 'menu.html'%}
    {% include 'submenu.html'%}
    {% include 'maincontent.html'%}
<script>
  let highlightedItemId = null;
  
  // === Submenu & Content Display ===
  function showSubmenu(type) {
    document.querySelectorAll('.submenu').forEach(menu => menu.classList.add('hidden'));
    const activeMenu = document.getElementById(`${type}-submenu`);
    if (activeMenu) activeMenu.classList.remove('hidden');
    hideAllMainContent();
  }

  function showContent(id) {
    hideAllMainContent();
    const content = document.getElementById(id);
    if (content) content.classList.remove('hidden');

    if (id === 'employee-applied') {
        loadEmployees();
    } else if (id === 'employee-selected') {
        loadSelectedEmployees();
    } else if (id === 'employee-active') {
        loadActiveEmployees();
    } else if (id === 'employee-inactive') {
        loadInactiveEmployees();
    } else if (id === 'student-registered') {
        loadRegisteredStudents();
    } else if (id === 'student-not-registered') {
        loadNotRegisteredStudents();
    } else if (id === 'student-completed') {
        loadCompletedStudents();
    } else if (id === 'lead-new') {
        loadNewLeads();
    } else if (id === 'lead-interested') {
        loadInterestedLeads();
    } else if (id === 'lead-not-interested') {
        loadNotInterestedLeads();
    }
  }

  function hideAllMainContent() {
    document.querySelectorAll('.main-content').forEach(section => section.classList.add('hidden'));
  }

  // === Applied Employees Table Rendering ===
  function loadEmployees() {
    fetch('/api/employee/applied/')
      .then(res => res.json())
      .then(data => {
        const body = document.getElementById('employee-body');
        body.innerHTML = '';

        if (data.employees.length === 0) {
          const emptyRow = document.createElement('tr');
          emptyRow.innerHTML = `<td colspan="9">No applied employees found.</td>`;
          body.appendChild(emptyRow);
        } else {
          data.employees.forEach(emp => {
            const row = document.createElement('tr');
            row.dataset.id = emp.id;
            
            if (highlightedItemId === emp.id) {
                row.classList.add('highlighted');
                setTimeout(() => row.scrollIntoView({ behavior: 'smooth', block: 'center' }), 100);
                setTimeout(() => {
                    row.classList.remove('highlighted');
                    highlightedItemId = null;
                }, 3000);
            }
            
            row.innerHTML = `
              <td>${emp.employee_id || ''}</td>
              <td>${emp.name || ''}</td>
              <td>${emp.gender || ''}</td>
              <td>${emp.phone || ''}</td>
              <td>${emp.location || ''}</td>
              <td>${emp.email || ''}</td>
              <td>${emp.join_date || ''}</td>
              <td>
                <select onchange="updateStatus(${emp.id}, this.value)">
                  <option value="applied" ${emp.status === 'applied' ? 'selected' : ''}>Applied</option>
                  <option value="selected" ${emp.status === 'selected' ? 'selected' : ''}>Selected</option>
                  <option value="active" ${emp.status === 'active' ? 'selected' : ''}>Active</option>
                  <option value="inactive" ${emp.status === 'inactive' ? 'selected' : ''}>Inactive</option>
                </select>
              </td>
              <td><button onclick="deleteEmployee(${emp.id})">üóëÔ∏è</button></td>
            `;
            body.appendChild(row);
          });
        }
      })
      .catch(err => console.error('Error loading employees:', err));
  }

  function updateStatus(id, status) {
    fetch(`/api/employee/update/${id}/`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCSRFToken() },
      body: JSON.stringify({ status })
    }).then(() => {
      if (!document.getElementById('employee-applied').classList.contains('hidden')) {
        loadEmployees();
      }
      if (!document.getElementById('employee-selected').classList.contains('hidden')) {
        loadSelectedEmployees();
      }
      if (!document.getElementById('employee-active').classList.contains('hidden')) {
        loadActiveEmployees();
      }
      if (!document.getElementById('employee-inactive').classList.contains('hidden')) {
        loadInactiveEmployees();
      }
    });
  }

  function deleteEmployee(id) {
    if (!confirm("Are you sure you want to delete this employee?")) return;
    fetch(`/api/employee/delete/${id}/`, {
      method: 'POST',
      headers: { 'X-CSRFToken': getCSRFToken() }
    }).then(() => {
      if (!document.getElementById('employee-applied').classList.contains('hidden')) {
        loadEmployees();
      }
      if (!document.getElementById('employee-selected').classList.contains('hidden')) {
        loadSelectedEmployees();
      }
      if (!document.getElementById('employee-active').classList.contains('hidden')) {
        loadActiveEmployees();
      }
      if (!document.getElementById('employee-inactive').classList.contains('hidden')) {
        loadInactiveEmployees();
      }
    });
  }

  // === Add New Employee Modal Logic ===
  document.getElementById('add-btn').addEventListener('click', () => {
    document.getElementById('addModal').classList.remove('hidden');
  });

  document.getElementById('add-form').addEventListener('submit', function (e) {
    e.preventDefault();
    const formData = Object.fromEntries(new FormData(this).entries());

    fetch('/api/employee/add/', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCSRFToken() },
      body: JSON.stringify(formData)
    }).then(() => {
      document.getElementById('addModal').classList.add('hidden');
      this.reset();
      loadEmployees();
    });
  });

  // === CSRF Token Helper ===
  function getCSRFToken() {
    const cookie = document.cookie.split(';').find(c => c.trim().startsWith('csrftoken='));
    return cookie ? cookie.split('=')[1] : '';
  }

  // === Initial Load ===
  document.addEventListener('DOMContentLoaded', function() {
    loadEmployees();
  });

  // === Load Selected Employees ===
  function loadSelectedEmployees() {
    fetch('/api/employee/selected/')
      .then(res => res.json())
      .then(data => {
        const body = document.getElementById('selected-body');
        body.innerHTML = '';

        data.employees.forEach(emp => {
          const row = document.createElement('tr');
          row.dataset.id = emp.id;
            
          if (highlightedItemId === emp.id) {
              row.classList.add('highlighted');
              setTimeout(() => row.scrollIntoView({ behavior: 'smooth', block: 'center' }), 100);
              setTimeout(() => {
                  row.classList.remove('highlighted');
                  highlightedItemId = null;
              }, 3000);
          }
          
          row.innerHTML = `
            <td>${emp.employee_id || ''}</td>
            <td>${emp.first_name} ${emp.last_name}</td>
            <td>${emp.gender || ''}</td>
            <td>${emp.phone || ''}</td>
            <td>${emp.location || ''}</td>
            <td>${emp.email || ''}</td>
            <td>${emp.join_date || ''}</td>
            <td>
              <select onchange="updateStatus(${emp.id}, this.value)">
                <option value="applied" ${emp.status.toLowerCase() === 'applied' ? 'selected' : ''}>Applied</option>
                <option value="selected" ${emp.status.toLowerCase() === 'selected' ? 'selected' : ''}>Selected</option>
                <option value="active" ${emp.status.toLowerCase() === 'active' ? 'selected' : ''}>Active</option>
                <option value="inactive" ${emp.status.toLowerCase() === 'inactive' ? 'selected' : ''}>Inactive</option>
              </select>
            </td>
            <td><button onclick="deleteEmployee(${emp.id})">üóëÔ∏è</button></td>
          `;
          body.appendChild(row);
        });
      });
  }

  // === Load Active Employees ===
  function loadActiveEmployees() {
    fetch('/api/active-employees/')
      .then(res => res.json())
      .then(data => {
        const body = document.getElementById('active-body');
        body.innerHTML = '';

        if (data.employees.length === 0) {
          const emptyRow = document.createElement('tr');
          emptyRow.innerHTML = `<td colspan="9">No active employees found.</td>`;
          body.appendChild(emptyRow);
        } else {
          data.employees.forEach(emp => {
            const row = document.createElement('tr');
            row.dataset.id = emp.id;
            
            if (highlightedItemId === emp.id) {
                row.classList.add('highlighted');
                setTimeout(() => row.scrollIntoView({ behavior: 'smooth', block: 'center' }), 100);
                setTimeout(() => {
                    row.classList.remove('highlighted');
                    highlightedItemId = null;
                }, 3000);
            }
            
            row.innerHTML = `
              <td>${emp.employee_id || ''}</td>
              <td>${emp.first_name} ${emp.last_name}</td>
              <td>${emp.gender || ''}</td>
              <td>${emp.phone || ''}</td>
              <td>${emp.location || ''}</td>
              <td>${emp.email || ''}</td>
              <td>${emp.join_date || ''}</td>
              <td>
                <select onchange="updateStatus(${emp.id}, this.value)">
                  <option value="applied" ${emp.status.toLowerCase() === 'applied' ? 'selected' : ''}>Applied</option>
                  <option value="selected" ${emp.status.toLowerCase() === 'selected' ? 'selected' : ''}>Selected</option>
                  <option value="active" ${emp.status.toLowerCase() === 'active' ? 'selected' : ''}>Active</option>
                  <option value="inactive" ${emp.status.toLowerCase() === 'inactive' ? 'selected' : ''}>Inactive</option>
                </select>
              </td>
              <td><button onclick="deleteEmployee(${emp.id})">üóëÔ∏è</button></td>
            `;
            body.appendChild(row);
          });
        }
      })
      .catch(err => console.error('Error loading active employees:', err));
  }

  // === Load Inactive Employees ===
  function loadInactiveEmployees() {
    fetch('/api/inactive-employees/')
      .then(res => res.json())
      .then(data => {
        const body = document.getElementById('inactive-body');
        body.innerHTML = '';

        if (data.employees.length === 0) {
          const emptyRow = document.createElement('tr');
          emptyRow.innerHTML = `<td colspan="9">No inactive employees found.</td>`;
          body.appendChild(emptyRow);
        } else {
          data.employees.forEach(emp => {
            const row = document.createElement('tr');
            row.dataset.id = emp.id;
            
            if (highlightedItemId === emp.id) {
                row.classList.add('highlighted');
                setTimeout(() => row.scrollIntoView({ behavior: 'smooth', block: 'center' }), 100);
                setTimeout(() => {
                    row.classList.remove('highlighted');
                    highlightedItemId = null;
                }, 3000);
            }
            
            row.innerHTML = `
              <td>${emp.employee_id || ''}</td>
              <td>${emp.first_name} ${emp.last_name}</td>
              <td>${emp.gender || ''}</td>
              <td>${emp.phone || ''}</td>
              <td>${emp.location || ''}</td>
              <td>${emp.email || ''}</td>
              <td>${emp.join_date || ''}</td>
              <td>
                <select onchange="updateStatus(${emp.id}, this.value)">
                  <option value="applied" ${emp.status.toLowerCase() === 'applied' ? 'selected' : ''}>Applied</option>
                  <option value="selected" ${emp.status.toLowerCase() === 'selected' ? 'selected' : ''}>Selected</option>
                  <option value="active" ${emp.status.toLowerCase() === 'active' ? 'selected' : ''}>Active</option>
                  <option value="inactive" ${emp.status.toLowerCase() === 'inactive' ? 'selected' : ''}>Inactive</option>
                </select>
              </td>
              <td><button onclick="deleteEmployee(${emp.id})">üóëÔ∏è</button></td>
            `;
            body.appendChild(row);
          });
        }
      })
      .catch(err => console.error('Error loading inactive employees:', err));
  }

  // === Student Registered Functions ===
  function loadRegisteredStudents() {
    fetch('/api/students/registered/')
      .then(response => {
        if (!response.ok) throw new Error('Network response was not ok');
        return response.json();
      })
      .then(data => {
        if (!data.success) throw new Error(data.error || 'Failed to load students');

        const body = document.getElementById('registered-body');
        body.innerHTML = '';

        if (data.students.length === 0) {
          const emptyRow = document.createElement('tr');
          emptyRow.innerHTML = `<td colspan="14">No registered students found.</td>`;
          body.appendChild(emptyRow);
        } else {
          data.students.forEach(student => {
            const row = document.createElement('tr');
            row.dataset.id = student.id;
            
            if (highlightedItemId === student.id) {
                row.classList.add('highlighted');
                setTimeout(() => row.scrollIntoView({ behavior: 'smooth', block: 'center' }), 100);
                setTimeout(() => {
                    row.classList.remove('highlighted');
                    highlightedItemId = null;
                }, 3000);
            }
            
            row.innerHTML = `
              <td>${student.student_id || ''}</td>
              <td>${student.name || ''}</td>
              <td>${student.gender || ''}</td>
              <td>${student.email || ''}</td>
              <td>${student.phone || ''}</td>
              <td>${student.location || ''}</td>
              <td>${student.department || ''}</td>
              <td>${student.enrollment_date || ''}</td>
              <td>${student.certificate_status || ''}</td>
              <td>${student.course_start_date || ''} to ${student.course_end_date || ''}</td>
              <td>${student.passed_out_year || '-'}</td>
              <td>${student.last_login || 'Never'}</td>
              <td>
                <select onchange="updateStudentStatus(${student.id}, this.value)">
                  <option value="registered" ${student.status === 'registered' ? 'selected' : ''}>Registered</option>
                  <option value="not_registered" ${student.status === 'not_registered' ? 'selected' : ''}>Not Registered</option>
                  <option value="completed" ${student.status === 'completed' ? 'selected' : ''}>Completed</option>
                </select>
              </td>
              <td>
                <button onclick="deleteStudent(${student.id})">üóëÔ∏è</button>
                <button onclick="editStudent(${student.id})">‚úèÔ∏è</button>
              </td>
            `;
            body.appendChild(row);
          });
        }
      })
      .catch(error => {
        console.error('Error loading students:', error);
        const body = document.getElementById('registered-body');
        body.innerHTML = `<tr><td colspan="14" style="color:red">Error loading students: ${error.message}</td></tr>`;
      });
  }

  document.getElementById('registered-add-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const studentData = {
      student_id: formData.get('student_id'),
      first_name: formData.get('first_name'),
      last_name: formData.get('last_name'),
      email: formData.get('email'),
      phone: formData.get('phone'),
      gender: formData.get('gender') || 'O',
      city: formData.get('city') || '',
      country: formData.get('country') || '',
      department: formData.get('department') || '',
      enrollment_date: formData.get('enrollment_date') || new Date().toISOString().split('T')[0],
      certificate_status: formData.get('certificate_status') || 'not_issued',
      status: 'registered'
    };

    fetch('/api/student/add/', {
      method: 'POST',
      headers: { 
        'Content-Type': 'application/json',
        'X-CSRFToken': getCSRFToken() 
      },
      body: JSON.stringify(studentData)
    })
    .then(response => {
      if (!response.ok) {
        return response.json().then(err => { throw new Error(err.error || 'Failed to add student'); });
      }
      return response.json();
    })
    .then(data => {
      if (data.success) {
        document.getElementById('registeredAddModal').classList.add('hidden');
        this.reset();
        loadRegisteredStudents();
        alert('Student added successfully!');
      } else {
        throw new Error(data.error || 'Failed to add student');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert(`Error: ${error.message}`);
    });
  });

  function updateStudentStatus(id, status) {
    fetch(`/api/student/update/${id}/`, {
      method: 'POST',
      headers: { 
        'Content-Type': 'application/json', 
        'X-CSRFToken': getCSRFToken() 
      },
      body: JSON.stringify({ status })
    })
    .then(response => {
      if (!response.ok) throw new Error('Failed to update status');
      return response.json();
    })
    .then(data => {
      if (data.success) {
        loadRegisteredStudents();
      } else {
        throw new Error(data.error || 'Status update failed');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert(`Error updating status: ${error.message}`);
    });
  }

  function deleteStudent(id) {
    if (!confirm("Are you sure you want to delete this student?")) return;
    fetch(`/api/student/delete/${id}/`, {
      method: 'POST',
      headers: { 'X-CSRFToken': getCSRFToken() }
    }).then(() => {
      loadRegisteredStudents();
    });
  }

  function editStudent(id) {
    console.log("Edit student with ID:", id);
  }

  // Load Not Registered Students
  function loadNotRegisteredStudents() {
    fetch('/api/students/not_registered/')
      .then(response => {
        if (!response.ok) throw new Error('Network response was not ok');
        return response.json();
      })
      .then(data => {
        if (!data.success) throw new Error(data.error || 'Failed to load students');

        const body = document.getElementById('not-registered-body');
        body.innerHTML = '';

        if (data.students.length === 0) {
          const emptyRow = document.createElement('tr');
          emptyRow.innerHTML = `<td colspan="10">No not registered students found.</td>`;
          body.appendChild(emptyRow);
        } else {
          data.students.forEach(student => {
            const row = document.createElement('tr');
            row.dataset.id = student.id;
            
            if (highlightedItemId === student.id) {
                row.classList.add('highlighted');
                setTimeout(() => row.scrollIntoView({ behavior: 'smooth', block: 'center' }), 100);
                setTimeout(() => {
                    row.classList.remove('highlighted');
                    highlightedItemId = null;
                }, 3000);
            }
            
            row.innerHTML = `
              <td>${student.student_id || ''}</td>
              <td>${student.name || ''}</td>
              <td>${student.gender || ''}</td>
              <td>${student.email || ''}</td>
              <td>${student.phone || ''}</td>
              <td>${student.location || ''}</td>
              <td>${student.department || ''}</td>
              <td>${student.created_at || ''}</td>
              <td>
                <select onchange="updateStudentStatus(${student.id}, this.value)">
                  <option value="registered" ${student.status === 'registered' ? 'selected' : ''}>Registered</option>
                  <option value="not_registered" ${student.status === 'not_registered' ? 'selected' : ''}>Not Registered</option>
                  <option value="completed" ${student.status === 'completed' ? 'selected' : ''}>Completed</option>
                </select>
              </td>
              <td>
                <button onclick="deleteStudent(${student.id})">üóëÔ∏è</button>
                <button onclick="editStudent(${student.id})">‚úèÔ∏è</button>
              </td>
            `;
            body.appendChild(row);
          });
        }
      })
      .catch(error => {
        console.error('Error loading not registered students:', error);
        const body = document.getElementById('not-registered-body');
        body.innerHTML = `<tr><td colspan="10" style="color:red">Error loading students: ${error.message}</td></tr>`;
      });
  }

  // Load Completed Students
  function loadCompletedStudents() {
    fetch('/api/students/completed/')
      .then(response => {
        if (!response.ok) throw new Error('Network response was not ok');
        return response.json();
      })
      .then(data => {
        if (!data.success) throw new Error(data.error || 'Failed to load students');

        const body = document.getElementById('completed-body');
        body.innerHTML = '';

        if (data.students.length === 0) {
          const emptyRow = document.createElement('tr');
          emptyRow.innerHTML = `<td colspan="13">No completed students found.</td>`;
          body.appendChild(emptyRow);
        } else {
          data.students.forEach(student => {
            const row = document.createElement('tr');
            row.dataset.id = student.id;
            
            if (highlightedItemId === student.id) {
                row.classList.add('highlighted');
                setTimeout(() => row.scrollIntoView({ behavior: 'smooth', block: 'center' }), 100);
                setTimeout(() => {
                    row.classList.remove('highlighted');
                    highlightedItemId = null;
                }, 3000);
            }
            
            row.innerHTML = `
              <td>${student.student_id || ''}</td>
              <td>${student.name || ''}</td>
              <td>${student.gender || ''}</td>
              <td>${student.email || ''}</td>
              <td>${student.phone || ''}</td>
              <td>${student.location || ''}</td>
              <td>${student.department || ''}</td>
              <td>${student.course_start_date || ''} to ${student.course_end_date || ''}</td>
              <td>${student.passed_out_year || ''}</td>
              <td>${student.certificate_status || ''}</td>
              <td>${student.certificate_issue_date || ''}</td>
              <td>
                <select onchange="updateStudentStatus(${student.id}, this.value)">
                  <option value="registered" ${student.status === 'registered' ? 'selected' : ''}>Registered</option>
                  <option value="not_registered" ${student.status === 'not_registered' ? 'selected' : ''}>Not Registered</option>
                  <option value="completed" ${student.status === 'completed' ? 'selected' : ''}>Completed</option>
                </select>
              </td>
              <td>
                <button onclick="deleteStudent(${student.id})">üóëÔ∏è</button>
                <button onclick="editStudent(${student.id})">‚úèÔ∏è</button>
              </td>
            `;
            body.appendChild(row);
          });
        }
      })
      .catch(error => {
        console.error('Error loading completed students:', error);
        const body = document.getElementById('completed-body');
        body.innerHTML = `<tr><td colspan="13" style="color:red">Error loading students: ${error.message}</td></tr>`;
      });
  }

  // Load New Leads
  function loadNewLeads() {
    fetch('/api/leads/new/')
      .then(response => {
        if (!response.ok) throw new Error('Network response was not ok');
        return response.json();
      })
      .then(data => {
        if (!data.success) throw new Error(data.error || 'Failed to load leads');

        const body = document.getElementById('new-lead-body');
        body.innerHTML = '';

        if (data.leads.length === 0) {
          const emptyRow = document.createElement('tr');
          emptyRow.innerHTML = `<td colspan="8">No new leads found.</td>`;
          body.appendChild(emptyRow);
        } else {
          data.leads.forEach(lead => {
            const row = document.createElement('tr');
            row.dataset.id = lead.id;
            
            if (highlightedItemId === lead.id) {
                row.classList.add('highlighted');
                setTimeout(() => row.scrollIntoView({ behavior: 'smooth', block: 'center' }), 100);
                setTimeout(() => {
                    row.classList.remove('highlighted');
                    highlightedItemId = null;
                }, 3000);
            }
            
            row.innerHTML = `
              <td>${lead.name || ''}</td>
              <td>${lead.email || ''}</td>
              <td>${lead.phone || ''}</td>
              <td>${lead.source || ''}</td>
              <td>${lead.interest || ''}</td>
              <td>${lead.created_at || ''}</td>
              <td>
                <select onchange="updateLeadStatus(${lead.id}, this.value)">
                  <option value="new" ${lead.status === 'new' ? 'selected' : ''}>New</option>
                  <option value="interested" ${lead.status === 'interested' ? 'selected' : ''}>Interested</option>
                  <option value="not_interested" ${lead.status === 'not_interested' ? 'selected' : ''}>Not Interested</option>
                  <option value="converted" ${lead.status === 'converted' ? 'selected' : ''}>Converted</option>
                </select>
              </td>
              <td>
                <button onclick="deleteLead(${lead.id})">üóëÔ∏è</button>
                <button onclick="editLead(${lead.id})">‚úèÔ∏è</button>
                <button onclick="viewLeadDetails(${lead.id})">üëÅÔ∏è</button>
              </td>
            `;
            body.appendChild(row);
          });
        }
      })
      .catch(error => {
        console.error('Error loading new leads:', error);
        const body = document.getElementById('new-lead-body');
        body.innerHTML = `<tr><td colspan="8" style="color:red">Error loading leads: ${error.message}</td></tr>`;
      });
  }

  // Lead Status Update
  function updateLeadStatus(id, status) {
    fetch(`/api/lead/update/${id}/`, {
      method: 'POST',
      headers: { 
        'Content-Type': 'application/json',
        'X-CSRFToken': getCSRFToken() 
      },
      body: JSON.stringify({ status })
    })
    .then(response => {
      if (!response.ok) throw new Error('Failed to update status');
      return response.json();
    })
    .then(data => {
      if (data.success) {
        loadNewLeads();
      } else {
        throw new Error(data.error || 'Status update failed');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert(`Error updating status: ${error.message}`);
    });
  }

  // Load Interested Leads
  function loadInterestedLeads() {
    fetch('/api/leads/interested/')
      .then(response => {
        if (!response.ok) throw new Error('Network response was not ok');
        return response.json();
      })
      .then(data => {
        if (!data.success) throw new Error(data.error || 'Failed to load leads');

        const body = document.getElementById('interested-lead-body');
        body.innerHTML = '';

        if (data.leads.length === 0) {
          body.innerHTML = `<tr><td colspan="10">No interested leads found</td></tr>`;
        } else {
          data.leads.forEach(lead => {
            const row = document.createElement('tr');
            row.dataset.id = lead.id;
            
            if (highlightedItemId === lead.id) {
                row.classList.add('highlighted');
                setTimeout(() => row.scrollIntoView({ behavior: 'smooth', block: 'center' }), 100);
                setTimeout(() => {
                    row.classList.remove('highlighted');
                    highlightedItemId = null;
                }, 3000);
            }
            
            row.innerHTML = `
              <td>${lead.name}</td>
              <td>${lead.email}</td>
              <td>${lead.phone}</td>
              <td>${lead.source}</td>
              <td>${lead.interest}</td>
              <td>${lead.notes}</td>
              <td>${lead.created_at}</td>
              <td>${lead.updated_at}</td>
              <td>
                <select onchange="updateLeadStatus(${lead.id}, this.value)">
                  <option value="new" ${lead.status === 'new' ? 'selected' : ''}>New</option>
                  <option value="interested" ${lead.status === 'interested' ? 'selected' : ''}>Interested</option>
                  <option value="not_interested" ${lead.status === 'not_interested' ? 'selected' : ''}>Not Interested</option>
                  <option value="converted" ${lead.status === 'converted' ? 'selected' : ''}>Converted</option>
                </select>
              </td>
              <td>
                <button onclick="deleteLead(${lead.id})">üóëÔ∏è</button>
                <button onclick="editLead(${lead.id})">‚úèÔ∏è</button>
                <button onclick="addNote(${lead.id})">üìù</button>
              </td>
            `;
            body.appendChild(row);
          });
        }
      })
      .catch(error => {
        console.error('Error loading interested leads:', error);
        const body = document.getElementById('interested-lead-body');
        body.innerHTML = `
          <tr>
            <td colspan="10" style="color:red">
              Error loading leads: ${error.message}
              <button onclick="loadInterestedLeads()">Retry</button>
            </td>
          </tr>`;
      });
  }

  function addNote(leadId) {
    const note = prompt("Enter your note:");
    if (note) {
      fetch(`/api/lead/add_note/${leadId}/`, {
        method: 'POST',
        headers: { 
          'Content-Type': 'application/json',
          'X-CSRFToken': getCSRFToken() 
        },
        body: JSON.stringify({ note })
      })
      .then(response => {
        if (!response.ok) throw new Error('Failed to add note');
        return response.json();
      })
      .then(data => {
        if (data.success) {
          loadInterestedLeads();
          alert('Note added successfully!');
        } else {
          throw new Error(data.error || 'Failed to add note');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert(`Error: ${error.message}`);
      });
    }
  }

  // Load Not Interested Leads
  function loadNotInterestedLeads() {
    fetch('/api/leads/not_interested/')
      .then(response => {
        if (!response.ok) throw new Error('Network response was not ok');
        return response.json();
      })
      .then(data => {
        if (!data.success) throw new Error(data.error || 'Failed to load leads');

        const body = document.getElementById('not-interested-lead-body');
        body.innerHTML = '';

        if (data.leads.length === 0) {
          body.innerHTML = `<tr><td colspan="10">No not interested leads found</td></tr>`;
        } else {
          data.leads.forEach(lead => {
            const row = document.createElement('tr');
            row.dataset.id = lead.id;
            
            if (highlightedItemId === lead.id) {
                row.classList.add('highlighted');
                setTimeout(() => row.scrollIntoView({ behavior: 'smooth', block: 'center' }), 50);
                setTimeout(() => {
                    row.classList.remove('highlighted');
                    highlightedItemId = null;
                }, 3000);
            }
            
            row.innerHTML = `
              <td>${lead.name}</td>
              <td>${lead.email}</td>
              <td>${lead.phone}</td>
              <td>${lead.source}</td>
              <td>${lead.interest}</td>
              <td>${lead.reason}</td>
              <td>${lead.created_at}</td>
              <td>${lead.updated_at}</td>
              <td>
                <select onchange="updateLeadStatus(${lead.id}, this.value)">
                  <option value="new" ${lead.status === 'new' ? 'selected' : ''}>New</option>
                  <option value="interested" ${lead.status === 'interested' ? 'selected' : ''}>Interested</option>
                  <option value="not_interested" ${lead.status === 'not_interested' ? 'selected' : ''}>Not Interested</option>
                  <option value="converted" ${lead.status === 'converted' ? 'selected' : ''}>Converted</option>
                </select>
              </td>
              <td>
                <button onclick="deleteLead(${lead.id})">üóëÔ∏è</button>
                <button onclick="editLead(${lead.id})">‚úèÔ∏è</button>
              </td>
            `;
            body.appendChild(row);
          });
        }
      })
      .catch(error => {
        console.error('Error loading not interested leads:', error);
        const body = document.getElementById('not-interested-lead-body');
        body.innerHTML = `
          <tr>
            <td colspan="10" style="color:red">
              Error loading leads: ${error.message}
              <button onclick="loadNotInterestedLeads()">Retry</button>
            </td>
          </tr>`;
      });
  }

  // Search functionality
  document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.querySelector('.search');
    const searchResults = document.createElement('div');
    searchResults.className = 'search-results';
    document.querySelector('.search-container').appendChild(searchResults);

    function debounce(func, wait) {
      let timeout;
      return function() {
        const context = this, args = arguments;
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(context, args), wait);
      };
    }

    function navigateToSection(type, subtype, id) {
      highlightedItemId = id;
      
      document.querySelectorAll('.main-content').forEach(section => {
        section.classList.add('hidden');
      });
      
      document.querySelectorAll('.submenu').forEach(menu => {
        menu.classList.add('hidden');
      });
      
      const menuType = type.toLowerCase();
      document.querySelector(`.list li[onclick*="${menuType}"]`).click();
      
      const submenu = document.getElementById(`${menuType}-submenu`);
      if (submenu) submenu.classList.remove('hidden');
      
      const contentId = `${menuType}-${subtype.toLowerCase().replace(' ', '-')}`;
      const contentSection = document.getElementById(contentId);
      if (contentSection) {
        contentSection.classList.remove('hidden');
      }
      
      searchResults.classList.remove('show');
      searchInput.value = '';
    }

    const performSearch = debounce(function(query) {
      if (query.length < 2) {
        searchResults.classList.remove('show');
        return;
      }

      fetch(`/api/search/?q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
          searchResults.innerHTML = '';
                    if (data.results && data.results.length > 0) {
            data.results.forEach(result => {
              const item = document.createElement('div');
              item.className = 'search-result-item';
              item.innerHTML = `
                <div class="search-result-type">${result.type}</div>
                <div class="search-result-name">${result.name}</div>
                <div class="search-result-id">ID: ${result.id}</div>
              `;
              item.addEventListener('click', () => {
                navigateToSection(result.type, result.subtype, result.id);
              });
              searchResults.appendChild(item);
            });
            searchResults.classList.add('show');
          } else {
            const noResults = document.createElement('div');
            noResults.className = 'search-no-results';
            noResults.textContent = 'No results found';
            searchResults.appendChild(noResults);
            searchResults.classList.add('show');
          }
        })
        .catch(error => {
          console.error('Search error:', error);
          searchResults.innerHTML = '<div class="search-error">Error performing search</div>';
          searchResults.classList.add('show');
        });
    }, 300);

    searchInput.addEventListener('input', function() {
      const query = this.value.trim();
      if (query) {
        performSearch(query);
      } else {
        searchResults.classList.remove('show');
      }
    });

    // Close search results when clicking outside
    document.addEventListener('click', function(event) {
      if (!event.target.closest('.search-container')) {
        searchResults.classList.remove('show');
      }
    });
  });

  // Close modal when clicking outside
  document.addEventListener('click', function(event) {
    if (event.target.classList.contains('modal')) {
      event.target.classList.add('hidden');
    }
  });

  // Close modal with escape key
  document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
      document.querySelectorAll('.modal').forEach(modal => {
        modal.classList.add('hidden');
      });
    }
  });

  // Form submission handlers
  document.getElementById('lead-add-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const leadData = {
      name: formData.get('name'),
      email: formData.get('email'),
      phone: formData.get('phone'),
      source: formData.get('source'),
      interest: formData.get('interest'),
      status: 'new'
    };

    fetch('/api/lead/add/', {
      method: 'POST',
      headers: { 
        'Content-Type': 'application/json',
        'X-CSRFToken': getCSRFToken() 
      },
      body: JSON.stringify(leadData)
    })
    .then(response => {
      if (!response.ok) {
        return response.json().then(err => { throw new Error(err.error || 'Failed to add lead'); });
      }
      return response.json();
    })
    .then(data => {
      if (data.success) {
        document.getElementById('leadAddModal').classList.add('hidden');
        this.reset();
        loadNewLeads();
        alert('Lead added successfully!');
      } else {
        throw new Error(data.error || 'Failed to add lead');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert(`Error: ${error.message}`);
    });
  });

  function deleteLead(id) {
    if (!confirm("Are you sure you want to delete this lead?")) return;
    fetch(`/api/lead/delete/${id}/`, {
      method: 'POST',
      headers: { 'X-CSRFToken': getCSRFToken() }
    })
    .then(response => {
      if (!response.ok) throw new Error('Failed to delete lead');
      return response.json();
    })
    .then(data => {
      if (data.success) {
        loadNewLeads();
        loadInterestedLeads();
        loadNotInterestedLeads();
      } else {
        throw new Error(data.error || 'Failed to delete lead');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert(`Error: ${error.message}`);
    });
  }

  function editLead(id) {
    console.log("Edit lead with ID:", id);
    // Implementation would go here
  }

  function viewLeadDetails(id) {
    fetch(`/api/lead/details/${id}/`)
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          const modal = document.getElementById('leadDetailsModal');
          const content = modal.querySelector('.modal-content');
          
          content.innerHTML = `
            <h2>Lead Details</h2>
            <p><strong>Name:</strong> ${data.lead.name}</p>
            <p><strong>Email:</strong> ${data.lead.email}</p>
            <p><strong>Phone:</strong> ${data.lead.phone}</p>
            <p><strong>Source:</strong> ${data.lead.source}</p>
            <p><strong>Interest:</strong> ${data.lead.interest}</p>
            <p><strong>Status:</strong> ${data.lead.status}</p>
            <p><strong>Created:</strong> ${data.lead.created_at}</p>
            <p><strong>Last Updated:</strong> ${data.lead.updated_at}</p>
            ${data.lead.notes ? `<p><strong>Notes:</strong> ${data.lead.notes}</p>` : ''}
            ${data.lead.reason ? `<p><strong>Reason:</strong> ${data.lead.reason}</p>` : ''}
          `;
          
          modal.classList.remove('hidden');
        } else {
          throw new Error(data.error || 'Failed to load lead details');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert(`Error: ${error.message}`);
      });
  }
</script>
</body>
</html>